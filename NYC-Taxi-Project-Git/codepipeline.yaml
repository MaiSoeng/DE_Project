AWSTemplateFormatVersion: '2010-09-09'
Description: 'CI/CD Pipeline for NYC Taxi ETL Pipeline using AWS CodePipeline'

Parameters:
  DeployEnvironment:
    Type: String
    Default: dev
    AllowedValues: [ dev, prod, staging ]

  ProjectName:
    Type: String
    Default: project-nyc-taxi
    Description: Project Name

  GitHubOwner:
    Type: String
    Description: Github repository owner

  GitHubRepo:
    Type: String
    Description: Github repository name

  GitHubBranch:
    Type: String
    Default: main
    Description: Github branch to deploy

  GitHubToken:
    Type: String
    NoEcho: true
    Description: Github personal access token

  NotificationEmail:
    Type: String
    Description: Email address to send notifications for pipeline failures

Resources:
  # S3 bucket to store pipeline artifacts
  ArtifactBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-${DeployEnvironment}-pipeline-artifacts'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
        - Id: DeleteOldVersions
          Status: Enabled
          NoncurrentVersionExpiration:
            NoncurrentDays: 90
        - Id: GlacierRule
          Prefix: glacier/
          Status: Enabled
          ExpirationInDays: 365
          Transitions:
          - TransitionInDays: 90
            StorageClass: GLACIER_IR

  # Notifications for pipeline failures
  PipelineNotification:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Sub '${ProjectName}-${DeployEnvironment}-pipeline-notifications'
      Subscription:
      - Protocol: email
        Endpoint: !Ref NotificationEmail

  # IAM Role for CodePipeline
  PipelineRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-${DeployEnvironment}-pipeline-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: codepipeline.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: PipelineExecutionPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - s3:GetBucketVersioning
            - s3:GetObject
            - s3:GetObjectVersion
            - s3:PutObject
            Resource:
            - !Sub 'arn:aws:s3:::${ArtifactBucket}/*'
            - !GetAtt ArtifactBucket.Arn
          - Effect: Allow
            Action:
            - codebuild:BatchGetBuilds
            - codebuild:StartBuild
            Resource:
            - !GetAtt CodeBuildProject.Arn
          - Effect: Allow
            Action:
            - cloudformation:CreateStack
            - cloudformation:DeleteStack
            - cloudformation:DescribeStacks
            - cloudformation:UpdateStack
            - cloudformation:CreateChangeSet
            - cloudformation:DeleteChangeSet
            - cloudformation:DescribeChangeSet
            - cloudformation:ExecuteChangeSet
            - cloudformation:SetStackPolicy
            - cloudformation:ValidateTemplate
            Resource:
            - !Sub 'arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${ProjectName}-*'
          - Effect: Allow
            Action:
            - iam:PassRole
            Resource: !GetAtt CloudFormationRole.Arn
          - Effect: Allow
            Action:
            - sns:Publish
            Resource: !GetAtt PipelineNotification.TopicArn

      - PolicyName: VPCAccess
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - ec2:CreateNetworkInterface
            - ec2:DescribeNetworkInterfaces
            - ec2:DeleteNetworkInterface
            Resource: '*'
          - Effect: Allow
            Action:
            - ec2:CreateNetworkInterfacePermission
            - ec2:DescribeNetworkInterfacePermissions
            - ec2:DeleteNetworkInterfacePermission
            Resource: '*'

  # IAM Role for CodeBuild
  CodeBuildRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-${DeployEnvironment}-codebuild-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: codebuild.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: CodeBuildPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
            - s3:ListBucket
            - s3:GetBucketLocation
            Resource:
            - !Sub 'arn:aws:s3:::${ArtifactBucket}/*'
            - !GetAtt ArtifactBucket.Arn
          - Effect: Allow
            Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
            Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/${ProjectName}-*'
          - Effect: Allow
            Action:
            - glue:GetJob
            - glue:GetJobRun
            - glue:GetJobRuns
            - glue:StartJobRun
            Resource: !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:job/${ProjectName}-*'
          - Effect: Allow
            Action:
            - sns:Publish
            Resource: !GetAtt PipelineNotification.TopicArn
          - Effect: Allow
            Action:
            - cloudformation:ValidateTemplate
            Resource: '*'

  # IAM Role for CloudFormation
  CloudFormationRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-${DeployEnvironment}-cloudformation-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: cloudformation.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: CloudFormationExecutionPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - iam:CreateRole
            - iam:DeleteRole
            - iam:GetRole
            - iam:PassRole
            - iam:AttachRolePolicy
            - iam:DetachRolePolicy
            - iam:PutRolePolicy
            - iam:DeleteRolePolicy
            - iam:CreateInstanceProfile
            - iam:DeleteInstanceProfile
            - iam:AddRoleToInstanceProfile
            - iam:RemoveRoleFromInstanceProfile
            - iam:GetInstanceProfile
            - iam:ListInstanceProfilesForRole
            Resource:
            - !Sub 'arn:aws:iam::${AWS::AccountId}:role/${ProjectName}-*'
            - !Sub 'arn:aws:iam::${AWS::AccountId}:instance-profile/${ProjectName}-*'

          # S3 
          - Effect: Allow
            Action:
            - s3:*
            Resource:
            - !Sub 'arn:aws:s3:::${ProjectName}-*'
            - !Sub 'arn:aws:s3:::${ProjectName}-*/*'

          # CodePipeline 
          - Effect: Allow
            Action:
            - codepipeline:CreatePipeline
            - codepipeline:DeletePipeline
            - codepipeline:GetPipeline
            - codepipeline:GetPipelineState
            - codepipeline:ListPipelines
            - codepipeline:UpdatePipeline
            - codepipeline:TagResource
            - codepipeline:UntagResource
            Resource: !Sub 'arn:aws:codepipeline:${AWS::Region}:${AWS::AccountId}:pipeline/${ProjectName}-*'

          # CodeBuild 
          - Effect: Allow
            Action:
            - codebuild:CreateProject
            - codebuild:DeleteProject
            - codebuild:GetProject
            - codebuild:ListProjects
            - codebuild:UpdateProject
            - codebuild:StartBuild
            - codebuild:StopBuild
            - codebuild:BatchGetBuilds
            Resource: !Sub 'arn:aws:codebuild:${AWS::Region}:${AWS::AccountId}:project/${ProjectName}-*'

          # Glue 
          - Effect: Allow
            Action:
            - glue:*
            Resource: !Sub 'arn:aws:glue:${AWS::Region}:${AWS::AccountId}:*'

          # RDS 
          - Effect: Allow
            Action:
            - rds:*
            Resource: !Sub 'arn:aws:rds:${AWS::Region}:${AWS::AccountId}:*'

          # Secrets Manager 
          - Effect: Allow
            Action:
            - secretsmanager:*
            Resource: !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${ProjectName}-*'

          # SNS 
          - Effect: Allow
            Action:
            - sns:*
            Resource: !Sub 'arn:aws:sns:${AWS::Region}:${AWS::AccountId}:${ProjectName}-*'

          # VPC 
          - Effect: Allow
            Action:
            - ec2:*
            Resource: '*'

          # CloudWatch 
          - Effect: Allow
            Action:
            - logs:*
            Resource:
            - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/glue/${ProjectName}-*'
            - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${ProjectName}-*'
            - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws-glue/jobs/${ProjectName}-*'
            - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws-glue/jobs/*'
            - !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/glue/jobs/*'

          # CloudWatch Alarms and Metrics
          - Effect: Allow
            Action:
            - cloudwatch:*
            Resource: '*'

          # Lambda 
          - Effect: Allow
            Action:
            - lambda:*
            Resource: '*'

          # EventBridge 
          - Effect: Allow
            Action:
            - events:*
            Resource: !Sub 'arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/${ProjectName}-*'

          # QuickSight 
          - Effect: Allow
            Action:
            - quicksight:*
            Resource: '*'

  # codebuild project
  CodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub '${ProjectName}-${DeployEnvironment}-codebuild-project'
      ServiceRole: !GetAtt CodeBuildRole.Arn
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_LARGE
        Image: aws/codebuild/amazonlinux2-x86_64-standard:5.0
        EnvironmentVariables:
        - Name: PROJECT_NAME
          Value: !Ref ProjectName
        - Name: DEPLOY_ENVIRONMENT
          Value: !Ref DeployEnvironment
        - Name: ARTIFACT_BUCKET
          Value: !Ref ArtifactBucket
        - Name: ENABLE_KINESIS
          Value: 'false'
      Source:
        Type: CODEPIPELINE
        BuildSpec: |
          version: 0.2
          phases:
            install:
              runtime-versions:
                python: 3.9
              commands:
                - echo "Installing dependencies"
                - python --version
                - pip --version
                - pip install --upgrade pip
                - pip install awscli boto3 pytest
                - echo "=== Repository Structure Debug ==="
                - echo "Current working directory:"
                - pwd
                - echo "Root directory contents:"
                - ls -la
                - echo "Checking if NYC-Taxi-Project-Git exists:"
                - if [ -d "NYC-Taxi-Project-Git" ]; then echo "NYC-Taxi-Project-Git directory EXISTS"; ls -la NYC-Taxi-Project-Git/; else echo "NYC-Taxi-Project-Git directory NOT FOUND"; fi
                - echo "All directories in current location:"
                - find . -maxdepth 1 -type d
                - echo "All YAML files in current location:"
                - find . -name "*.yaml" -o -name "*.yml"
                - echo "=== End Debug ==="
            pre_build:
              commands:
                - echo Pre-build phase
                - cd NYC-Taxi-Project-Git
                - echo "Current directory:" && pwd
                - echo "Files in current directory:" && ls -la
                - echo Validating CloudFormation template
                - echo "Skipping Main-CloudFormation-v2.yaml validation"
                - aws cloudformation validate-template --template-body file://Zone.yaml
                - aws cloudformation validate-template --template-body file://codepipeline.yaml
                - echo Validating parameters.json
                - python -m json.tool parameters.json > /dev/null && echo "parameters.json is valid" || (echo "parameters.json is invalid" && exit 1)
            build:
               commands:
                 - echo Build phase
                 - echo "Current directory:" && pwd
                 - echo "Files in current directory:" && ls -la
                 - echo Running syntax checks on Python Scripts
                 - python -m py_compile taxi_etl.py
                 - echo Running syntax checks on SQL Scripts
                 - echo "SQL syntax validation completed"
                 - echo running unit tests
                 - |
                   if [ -d "tests/" ]; then
                     python -m pytest tests/ -v || true
                   else
                     echo "No tests directory found, skipping tests"
                   fi
                 - echo Packaging artifacts
                 - zip -r etl_scripts.zip *.py *.sql
            post_build:
             commands:
               - echo Post-build phase
               - echo "Build completed successfully"
               - echo "Artifacts will be automatically uploaded by CodePipeline"
          artifacts:
            base-directory: NYC-Taxi-Project-Git
            files:
            - etl_scripts.zip
            - Main-CloudFormation-v1.yaml
            - Main-CloudFormation-v2.yaml
            - Zone.yaml
            - codepipeline.yaml
            - parameters.json
            - Aurora-SQL.sql
            - taxi_etl.py
            - parameters-template.json
            name: BuildArtifact

  # CodePipeline
  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: !Sub '${ProjectName}-${DeployEnvironment}-pipeline'
      RoleArn: !GetAtt PipelineRole.Arn
      ArtifactStore:
        Type: S3
        Location: !Ref ArtifactBucket
      Stages:
      # Get code from GitHub
      - Name: Source
        Actions:
        - Name: SourceAction
          ActionTypeId:
            Category: Source
            Owner: ThirdParty
            Provider: GitHub
            Version: '1'
          Configuration:
            Owner: !Ref GitHubOwner
            Repo: !Ref GitHubRepo
            Branch: !Ref GitHubBranch
            OAuthToken: !Ref GitHubToken
            PollForSourceChanges: 'true'
          OutputArtifacts:
          - Name: SourceOutput

      # Build project
      - Name: Build
        Actions:
        - Name: BuildAction
          ActionTypeId:
            Category: Build
            Owner: AWS
            Provider: CodeBuild
            Version: '1'
          Configuration:
            ProjectName: !Ref CodeBuildProject
          InputArtifacts:
          - Name: SourceOutput
          OutputArtifacts:
          - Name: BuildOutput

      # Deploy to CloudFormation
      - Name: Deploy
        Actions:
        # Create ChangeSet
        - Name: CreateChangeSet
          ActionTypeId:
            Category: Deploy
            Owner: AWS
            Provider: CloudFormation
            Version: '1'
          Configuration:
            ActionMode: CHANGE_SET_REPLACE
            ChangeSetName: !Sub '${ProjectName}-${DeployEnvironment}-changeset'
            StackName: !Sub '${ProjectName}-${DeployEnvironment}'
            TemplatePath: BuildOutput::Main-CloudFormation-v2.yaml
            TemplateConfiguration: BuildOutput::parameters.json
            Capabilities: CAPABILITY_NAMED_IAM
            RoleArn: !GetAtt CloudFormationRole.Arn
          InputArtifacts:
          - Name: BuildOutput
          RunOrder: 1

        # Execute ChangeSet
        - Name: ExecuteChangeSet
          ActionTypeId:
            Category: Deploy
            Owner: AWS
            Provider: CloudFormation
            Version: '1'
          Configuration:
            ActionMode: CHANGE_SET_EXECUTE
            ChangeSetName: !Sub '${ProjectName}-${DeployEnvironment}-changeset'
            StackName: !Sub '${ProjectName}-${DeployEnvironment}'
            RoleArn: !GetAtt CloudFormationRole.Arn
          RunOrder: 2

        # Deploy Zone Stack
        - Name: CreateZoneChangeSet
          ActionTypeId:
            Category: Deploy
            Owner: AWS
            Provider: CloudFormation
            Version: '1'
          Configuration:
            ActionMode: CHANGE_SET_REPLACE
            ChangeSetName: !Sub '${ProjectName}-${DeployEnvironment}-zone-changeset'
            StackName: !Sub '${ProjectName}-${DeployEnvironment}-zone'
            TemplatePath: BuildOutput::Zone.yaml
            Capabilities: CAPABILITY_NAMED_IAM
            RoleArn: !GetAtt CloudFormationRole.Arn
            ParameterOverrides: !Sub |
              {
                "ProjectName": "${ProjectName}"
              }
          InputArtifacts:
          - Name: BuildOutput
          RunOrder: 3

        # Execute Zone ChangeSet
        - Name: ExecuteZoneChangeSet
          ActionTypeId:
            Category: Deploy
            Owner: AWS
            Provider: CloudFormation
            Version: '1'
          Configuration:
            ActionMode: CHANGE_SET_EXECUTE
            ChangeSetName: !Sub '${ProjectName}-${DeployEnvironment}-zone-changeset'
            StackName: !Sub '${ProjectName}-${DeployEnvironment}-zone'
            RoleArn: !GetAtt CloudFormationRole.Arn
          RunOrder: 4

      # Post-Deploy Stage
      - Name: PostDeploy
        Actions:
        - Name: UploadScriptsAndInitialize
          ActionTypeId:
            Category: Invoke
            Owner: AWS
            Provider: Lambda
            Version: '1'
          Configuration:
            FunctionName: project-nyc-taxi-postdeploy
            UserParameters: !Sub |
              {
                "StackName": "${ProjectName}-${DeployEnvironment}",
                "ProjectName": "${ProjectName}"
              }
          InputArtifacts:
          - Name: BuildOutput
          RunOrder: 1

  # Github Webhook
  GithubWebhook:
    Type: AWS::CodePipeline::Webhook
    Properties:
      Name: !Sub '${ProjectName}-${DeployEnvironment}-github-webhook'
      Authentication: GITHUB_HMAC
      AuthenticationConfiguration:
        SecretToken: !Ref GitHubToken
      Filters:
      - JsonPath: $.ref
        MatchEquals: refs/heads/main
      - JsonPath: $.commits[*].modified[*]
        MatchEquals: !Sub '${ProjectName}-*'
      TargetPipeline: !Ref Pipeline
      TargetAction: SourceAction
      TargetPipelineVersion: 1
      RegisterWithThirdParty: true

# Outputs
Outputs:
  PipelineName:
    Description: CodePipeline Name
    Value: !Ref Pipeline
    Export:
      Name: !Sub '${ProjectName}-${DeployEnvironment}-pipeline-name'

  PipelineUrl:
    Description: CodePipeline URL
    Value: !Sub 'https://console.aws.amazon.com/codesuite/codepipeline/pipelines/${Pipeline}/view?region=${AWS::Region}'

  ArtifactBucketName:
    Description: S3 Bucket for Pipeline Artifacts
    Value: !Ref ArtifactBucket
    Export:
      Name: !Sub '${ProjectName}-${DeployEnvironment}-artifact-bucket'

  CodeBuildProjectName:
    Description: CodeBuild Project Name
    Value: !Ref CodeBuildProject
    Export:
      Name: !Sub '${ProjectName}-${DeployEnvironment}-codebuild-project'

  NotificationTopicArn:
    Description: SNS Topic ARN for Pipeline Notifications
    Value: !GetAtt PipelineNotification.TopicArn
    Export:
      Name: !Sub '${ProjectName}-${DeployEnvironment}-notification-topic'
